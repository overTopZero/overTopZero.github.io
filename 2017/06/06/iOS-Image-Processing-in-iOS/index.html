<!DOCTYPE html>
<html >
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Craco" />



<meta name="description" content="图形图像的基础知识, 位图图像原图的修改">
<meta property="og:type" content="article">
<meta property="og:title" content="Image Processing in iOS">
<meta property="og:url" content="http://zhulele90.cn/2017/06/06/iOS-Image-Processing-in-iOS/index.html">
<meta property="og:site_name" content="Craco的博客">
<meta property="og:description" content="图形图像的基础知识, 位图图像原图的修改">
<meta property="og:image" content="http://www.cocoachina.com/cms/uploads/allimg/140812/4196_140812105524_1.png">
<meta property="og:image" content="https://koenig-media.raywenderlich.com/uploads/2014/03/GPUFilterChain.png">
<meta property="og:updated_time" content="2017-06-06T09:47:56.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Image Processing in iOS">
<meta name="twitter:description" content="图形图像的基础知识, 位图图像原图的修改">
<meta name="twitter:image" content="http://www.cocoachina.com/cms/uploads/allimg/140812/4196_140812105524_1.png">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="Craco的博客" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.jpeg">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>Image Processing in iOS | Craco的博客</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="http://oq0zg621g.bkt.clouddn.com/icon.jpeg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Craco</a></h1>
        </hgroup>

        
        <p class="header-subtitle">一个热爱编程的程序猿</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜單</li>
                        <li>標籤</li>
                        
                        <li>友情鏈接</li>
                        
                        
                        <li>關於我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="/overtop1990@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/1/">1</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/">Javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS、图层/">iOS、图层</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/冒泡/">冒泡</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于前端</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Craco</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="http://oq0zg621g.bkt.clouddn.com/icon.jpeg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Craco</a></h1>
            </hgroup>
            
            <p class="header-subtitle">一个热爱编程的程序猿</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="/overtop1990@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="標籤" friends="友情鏈接" about="關於我"/>
</nav>
      <div class="body-wrap"><article id="post-iOS-Image-Processing-in-iOS" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/06/iOS-Image-Processing-in-iOS/" class="article-date">
      <time datetime="2017-06-06T07:26:40.000Z" itemprop="datePublished">2017-06-06 15:26:40</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Image Processing in iOS
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>图形图像的基础知识, 位图图像原图的修改</p>
<a id="more"></a>
<h1 id="Image-Processing-in-iOS"><a href="#Image-Processing-in-iOS" class="headerlink" title="Image Processing in iOS"></a>Image Processing in iOS</h1><h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><ul>
<li><p>什么是图形图像?<br>  一张图像就是像素点的集合，每一个像素都是一个单独明了的颜色.图像一般情况下都存储成数组，你可以把他们相像成2维数组。</p>
</li>
<li><p>如何用字节来表示颜色<br>  表示颜色的方式有许多种:</p>
<ul>
<li>最简单的32位RGBA模式 – 32位RGBA模式会将一个颜色值存储在32位，或者4个字节中。每一个字节存储一个部分或者一个颜色通道.可以表示接近17亿的颜色</li>
</ul>
</li>
<li><p>颜色空间</p>
<ul>
<li>RGB模式表示颜色是颜色空间的一个例子。它只是众多存储颜色方法中的一种。</li>
<li>灰阶空间。像它的名字一样，所有的图形都只有黑和白，只需要保存一个值来表示这种颜色</li>
<li>HSV，使用色调，饱和度和亮度来直观的存储颜色值。你可以把这三个部分这样来看:<ul>
<li>色调就是颜色<ul>
<li>饱和度就是这个颜色有多么的饱满</li>
<li>值就是颜色的亮度有多亮</li>
<li>YUV是另外一种常见的颜色空间，电视机使用的就是这种方式</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>坐标系统</p>
<ul>
<li>UIImage和UIView使用的是左上原点坐标，Core Image和Core Graphics使用的是左下原点坐标。</li>
</ul>
</li>
<li><p>图形压缩</p>
<ul>
<li>如果你使用一张8像素的图形做运算，它将会消耗810^6像素4比特/像素=32兆字节内存. 这就是为什么会出现jpeg,png和其它图形格式的原因。这些都是图形压缩格式。</li>
</ul>
</li>
</ul>
<h3 id="四个流行的图形图像处理方法"><a href="#四个流行的图形图像处理方法" class="headerlink" title="四个流行的图形图像处理方法"></a>四个流行的图形图像处理方法</h3><h4 id="位图图像原图修改"><a href="#位图图像原图修改" class="headerlink" title="位图图像原图修改"></a>位图图像原图修改</h4><ul>
<li>定义一个方法 修改图片</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line">- (UIImage *)processUsingPixels:(UIImage*)inputImage&#123;</div><div class="line"></div><div class="line"></div><div class="line">	// 1.把UIImage对象转换为需要被核心图形库调用的CGImage对象。同时，得到图形的宽度和高度。</div><div class="line">	CGImageRef inputCGImage = [inputImage CGImage];</div><div class="line">	NSUInteger inputWidth = CGImageGetWidth(inputCGImage);</div><div class="line">  	NSUInteger inputHeight = CGImageGetHeight(inputCGImage);</div><div class="line">		</div><div class="line">	// 2.由于你使用的是32位RGB颜色空间模式，你需要定义一些参数bytesPerPixel（每像素大小）和bitsPerComponent（每个颜色通道大小），然后计算图像bytesPerRow（每行有大）。最后，使用一个数组来存储像素的值。</div><div class="line">	UInt32 * inputPixels;</div><div class="line">	NSUInteger bytesPerPixel = 4;</div><div class="line">  	NSUInteger bitsPerComponent = 8;</div><div class="line">  	NSUInteger inputBytesPerRow = bytesPerPixel * inputWidth;</div><div class="line">  	inputPixels = (UInt32 *)calloc(inputHeight * inputWidth, sizeof(UInt32));</div><div class="line"></div><div class="line">	// 3.创建一个RGB模式的颜色空间CGColorSpace和一个容器CGBitmapContext,将像素指针参数传递到容器中缓存进行存储。在后面的章节中将会进一步研究核图形库。</div><div class="line">	CGColorSpaceRef colorSpace = CGColorSpaceCreateDeviceRGB();</div><div class="line">	CGContextRef context = CGBitmapContextCreate(inputPixels, inputWidth, inputHeight,</div><div class="line">                                               bitsPerComponent, inputBytesPerRow, colorSpace,</div><div class="line">                                               kCGImageAlphaPremultipliedLast | kCGBitmapByteOrder32Big);</div><div class="line">	// 4.把缓存中的图形绘制到显示器上。像素的填充格式是由你在创建context的时候进行指定的</div><div class="line">	CGContextDrawImage(context, CGRectMake(0, 0, inputWidth, inputHeight), inputCGImage);</div><div class="line"></div><div class="line">	// 5.创建一个幽灵的CGImageRef对象</div><div class="line">	UIImage * ghostImage = [UIImage imageNamed:@&quot;ghost&quot;];</div><div class="line">  CGImageRef ghostCGImage = [ghostImage CGImage];</div><div class="line"></div><div class="line">	// 6.把幽灵的图像宽度缩小25%，并把它的原点设定在点ghostOrigin</div><div class="line">	CGFloat ghostImageAspectRatio = ghostImage.size.width / ghostImage.size.height;</div><div class="line">	  NSInteger targetGhostWidth = inputWidth * 0.25;</div><div class="line">	  CGSize ghostSize = CGSizeMake(targetGhostWidth, targetGhostWidth / ghostImageAspectRatio);</div><div class="line">	  CGPoint ghostOrigin = CGPointMake(inputWidth * 0.5, inputHeight * 0.2); </div><div class="line">	  </div><div class="line"> 	// 7.创建一张幽灵图像的缓存图</div><div class="line">	NSUInteger ghostBytesPerRow = bytesPerPixel * ghostSize.width;</div><div class="line">	  </div><div class="line">	  UInt32 * ghostPixels = (UInt32 *)calloc(ghostSize.width * ghostSize.height, sizeof(UInt32));</div><div class="line">	  </div><div class="line">	  CGContextRef ghostContext = CGBitmapContextCreate(ghostPixels, ghostSize.width, ghostSize.height,</div><div class="line">	                                                    bitsPerComponent, ghostBytesPerRow, colorSpace,</div><div class="line">	                                                    kCGImageAlphaPremultipliedLast | kCGBitmapByteOrder32Big);</div><div class="line">	  </div><div class="line">	  CGContextDrawImage(ghostContext, CGRectMake(0, 0, ghostSize.width, ghostSize.height),ghostCGImage);</div><div class="line">	  </div><div class="line">	// 8.如同其它位图运算一样，你需要一些循环来遍历每一个像素</div><div class="line">  NSUInteger offsetPixelCountForInput = ghostOrigin.y * inputWidth + ghostOrigin.x;</div><div class="line">  for (NSUInteger j = 0; j &lt; ghostSize.height; j++) &#123;</div><div class="line">    for (NSUInteger i = 0; i &lt; ghostSize.width; i++) &#123;</div><div class="line">      UInt32 *inputPixel = inputPixels + j * inputWidth + i + offsetPixelCountForInput;</div><div class="line">      UInt32 inputColor = *inputPixel;</div><div class="line">      </div><div class="line">        UInt32 * ghostPixel5 = ghostPixels + j * (int)ghostSize.width + i;</div><div class="line">        UInt32  ghostColor = *ghostPixel5;</div><div class="line">      </div><div class="line">      // 你将幽灵图像的每一个像素的透明通道都乘以了0.5，使它成为半透明状态。然后将它混合到图像中像之前讨论的那样</div><div class="line">      CGFloat ghostAlpha = 0.5f * (A(ghostColor) / 255.0);</div><div class="line">      UInt32 newR = R(inputColor) * (1 - ghostAlpha) + R(ghostColor) * ghostAlpha;</div><div class="line">      UInt32 newG = G(inputColor) * (1 - ghostAlpha) + G(ghostColor) * ghostAlpha;</div><div class="line">      UInt32 newB = B(inputColor) * (1 - ghostAlpha) + B(ghostColor) * ghostAlpha;</div><div class="line">      </div><div class="line">      //clamping部分将每个颜色的值范围进行限定到0到255之间，虽然一般情况下值不会越界。但是，大多数情况下需要进行这种限定防止发生意外的错误输出</div><div class="line">      newR = MAX(0,MIN(255, newR));</div><div class="line">      newG = MAX(0,MIN(255, newG));</div><div class="line">      newB = MAX(0,MIN(255, newB));</div><div class="line">      </div><div class="line">      *inputPixel = RGBAMake(newR, newG, newB, A(inputColor));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">	// 9.把每一个像素的红色，绿色，蓝色通道的值设定成三个通道原始颜色值的平均值 变成黑白颜色</div><div class="line"></div><div class="line">  for (NSUInteger j = 0; j &lt; inputHeight; j++) &#123;</div><div class="line">    for (NSUInteger i = 0; i &lt; inputWidth; i++) &#123;</div><div class="line">      UInt32 * currentPixel = inputPixels + (j * inputWidth) + i;</div><div class="line">      UInt32 color = *currentPixel;</div><div class="line">      </div><div class="line">      // Average of RGB = greyscale</div><div class="line">      UInt32 averageColor = (R(color) + G(color) + B(color)) / 3.0;</div><div class="line">      </div><div class="line">      *currentPixel = RGBAMake(averageColor, averageColor, averageColor, A(color));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">	// 10.创建一个新的图片</div><div class="line">  CGImageRef newCGImage = CGBitmapContextCreateImage(context);</div><div class="line">  UIImage * processedImage = [UIImage imageWithCGImage:newCGImage];</div><div class="line"></div><div class="line"> 	// 11.清除内存。ARC不能代替你对CGImageRefs和CGContexts进行管理</div><div class="line">  CGColorSpaceRelease(colorSpace);</div><div class="line">  CGContextRelease(context);</div><div class="line">  CGContextRelease(ghostContext);</div><div class="line">  free(inputPixels);</div><div class="line">  free(ghostPixels);</div><div class="line">	// 12.返回处理好的图片</div><div class="line">	return processedImage;	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后的效果图:</p>
<p><img src="http://www.cocoachina.com/cms/uploads/allimg/140812/4196_140812105524_1.png" alt="效果图" title="效果图">    </p>
<h4 id="使用Core-Graphics库"><a href="#使用Core-Graphics库" class="headerlink" title="使用Core Graphics库"></a>使用Core Graphics库</h4><ul>
<li>直接上代码:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">- (UIImage *)processUsingCoreGraphics:(UIImage*)input &#123;</div><div class="line">  CGRect imageRect = &#123;CGPointZero,input.size&#125;;</div><div class="line">  NSInteger inputWidth = CGRectGetWidth(imageRect);</div><div class="line">  NSInteger inputHeight = CGRectGetHeight(imageRect);</div><div class="line">  </div><div class="line">  // 1. 添加ghost图片并且计算Ghosty的位置</div><div class="line">  UIImage * ghostImage = [UIImage imageNamed:@&quot;ghost.png&quot;];</div><div class="line">  CGFloat ghostImageAspectRatio = ghostImage.size.width / ghostImage.size.height;</div><div class="line">  </div><div class="line">  NSInteger targetGhostWidth = inputWidth * 0.25;</div><div class="line">  CGSize ghostSize = CGSizeMake(targetGhostWidth, targetGhostWidth / ghostImageAspectRatio);</div><div class="line">  CGPoint ghostOrigin = CGPointMake(inputWidth * 0.5, inputHeight * 0.2);</div><div class="line">  </div><div class="line">  CGRect ghostRect = &#123;ghostOrigin, ghostSize&#125;;</div><div class="line">  </div><div class="line">  UIGraphicsBeginImageContext(input.size);</div><div class="line">  CGContextRef context = UIGraphicsGetCurrentContext();</div><div class="line"></div><div class="line">  // 把你的图像绘制到context中</div><div class="line">  CGAffineTransform flip = CGAffineTransformMakeScale(1.0, -1.0);</div><div class="line">  CGAffineTransform flipThenShift = CGAffineTransformTranslate(flip,0,-inputHeight);</div><div class="line">  CGContextConcatCTM(context, flipThenShift);</div><div class="line">  </div><div class="line">  // 1.1 将图片写入新的context里面</div><div class="line">  CGContextDrawImage(context, imageRect, [input CGImage]);</div><div class="line">  </div><div class="line">  // 1.2 设置alpha值为0.5，这只会影响后面的图像。 混合模式设置为kCGBlendModeSourceAtop. 然后翻转幽灵的坐标把它绘制在图像中.</div><div class="line">  CGContextSetBlendMode(context, kCGBlendModeSourceAtop);</div><div class="line">  CGContextSetAlpha(context,0.5);</div><div class="line">  CGRect transformedGhostRect = CGRectApplyAffineTransform(ghostRect, flipThenShift);</div><div class="line">  CGContextDrawImage(context, transformedGhostRect, [ghostImage CGImage]);</div><div class="line">  // 1.3 取回处理的图像</div><div class="line">  UIImage * imageWithGhost = UIGraphicsGetImageFromCurrentImageContext();</div><div class="line">  UIGraphicsEndImageContext();</div><div class="line">    </div><div class="line">  // 2. 绘制你的图像到一个灰度（grayscale）context中</div><div class="line">  </div><div class="line">  // 2.1 创建一个带灰度的context</div><div class="line">  CGColorSpaceRef colorSpace = CGColorSpaceCreateDeviceGray();</div><div class="line">  context = CGBitmapContextCreate(nil, inputWidth, inputHeight,</div><div class="line">                           8, 0, colorSpace, (CGBitmapInfo)kCGImageAlphaNone);</div><div class="line">  </div><div class="line">  // 2.2 绘制图像进入context中</div><div class="line">  CGContextDrawImage(context, imageRect, [imageWithGhost CGImage]);</div><div class="line">  </div><div class="line">  // 2.3 取回处理后的图像</div><div class="line">  CGImageRef imageRef = CGBitmapContextCreateImage(context);</div><div class="line">  UIImage * finalImage = [UIImage imageWithCGImage:imageRef];</div><div class="line">  </div><div class="line">  // 清除缓存</div><div class="line">  CGColorSpaceRelease(colorSpace);</div><div class="line">  CGContextRelease(context);</div><div class="line">  CFRelease(imageRef);</div><div class="line">  </div><div class="line">  return finalImage;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>内存使用：当执行图像处理时，密切关注内存使用情况。像在第一节中讨论的一样，一个8M像素的图像占用了高达32M的内存。尽量避免在内存中同一时间保持同一图像的多个复制。</p>
</li>
<li><p>注意到为什么我们第二次需要释放context而第一次不需要了吗？这是因为第一次时，你使用UIGraphicsGetCurrentImageContext()获取了context。这里的关键词是‘get’。‘Get’意味着你获取了当前context的引用，你并不持有它。</p>
</li>
<li><p>在第二次中，你调用了CGBitmapContextCreateImage()，Create意味着你持有这个对象，并需要管理它的生命周期。这也是你为什么需要释放imageRef的原因，因为你是通过CGBitmapContextCreateImage()创建它的。    </p>
</li>
</ul>
<h4 id="使用Core-Image库"><a href="#使用Core-Image库" class="headerlink" title="使用Core Image库"></a>使用Core Image库</h4><ul>
<li>Core Image是Apple的图像处理的解决方案。它避免了所有底层的像素操作方法，转而使用高级别的滤镜替代了它们。</li>
<li>Core Image最好的部分在于它对比操作原始像素或Core Graphics有着极好的性能。这个库使用CPU和GPU混合处理提供接近实时的性能。</li>
<li>Apple还提供了巨大的预先制作的滤镜库</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">#import &quot;UIImage+OrientationFix.h&quot;</div><div class="line">- (UIImage *)processUsingCoreImage:(UIImage*)input &#123;</div><div class="line">  CIImage * inputCIImage = [[CIImage alloc] initWithImage:input];</div><div class="line">  </div><div class="line">  // 1.创建CIColorControls滤镜，设置它的inputSaturation值为0。你可能记得，饱和度是HSV颜色空间的一个通道。这里的0表示了灰度。</div><div class="line">  CIFilter * grayFilter = [CIFilter filterWithName:@&quot;CIColorControls&quot;];</div><div class="line">  [grayFilter setValue:@(0) forKeyPath:@&quot;inputSaturation&quot;];</div><div class="line">  </div><div class="line">  // 2. 创建一个和输入图像一样大小的填充的幽灵图像</div><div class="line">  </div><div class="line">  // Cheat: create a larger ghost image</div><div class="line">  UIImage * ghostImage = [self createPaddedGhostImageWithSize:input.size];</div><div class="line">  CIImage * ghostCIImage = [[CIImage alloc] initWithImage:ghostImage];</div><div class="line">	// 3.创建CIColorMatrix滤镜，设置它的alphaVector值为[0 0 0.5 0]。这将给幽灵的alpha值增加0.5。</div><div class="line">  CIFilter * alphaFilter = [CIFilter filterWithName:@&quot;CIColorMatrix&quot;];</div><div class="line">  CIVector * alphaVector = [CIVector vectorWithX:0 Y:0 Z:0.5 W:0];</div><div class="line">  [alphaFilter setValue:alphaVector forKeyPath:@&quot;inputAVector&quot;];</div><div class="line">  // 4.创建CISourceAtopCompositing滤镜来进行alpha混合</div><div class="line">  CIFilter * blendFilter = [CIFilter filterWithName:@&quot;CISourceAtopCompositing&quot;];</div><div class="line">  </div><div class="line">  // 5. 合并你的滤镜来处理图像</div><div class="line">  [alphaFilter setValue:ghostCIImage forKeyPath:@&quot;inputImage&quot;];</div><div class="line">  ghostCIImage = [alphaFilter outputImage];</div><div class="line"></div><div class="line">  [blendFilter setValue:ghostCIImage forKeyPath:@&quot;inputImage&quot;];</div><div class="line">  [blendFilter setValue:inputCIImage forKeyPath:@&quot;inputBackgroundImage&quot;];</div><div class="line">  CIImage * blendOutput = [blendFilter outputImage];</div><div class="line">  </div><div class="line">  [grayFilter setValue:blendOutput forKeyPath:@&quot;inputImage&quot;];</div><div class="line">  CIImage * outputCIImage = [grayFilter outputImage];</div><div class="line">  </div><div class="line">  // 6. 渲染输出CIImage到CGImage，创建最终的UIImage</div><div class="line">  CIContext * context = [CIContext contextWithOptions:nil];</div><div class="line">  CGImageRef outputCGImage = [context createCGImage:outputCIImage fromRect:[outputCIImage extent]];</div><div class="line">  UIImage * outputImage = [UIImage imageWithCGImage:outputCGImage];</div><div class="line">  // 7. 释放内存</div><div class="line">  CGImageRelease(outputCGImage);</div><div class="line">  </div><div class="line">  return outputImage;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 使用Core Image，你设置了大量的滤镜来处理你的图像 – 你使用了CIColorControls滤镜来设置灰度，CIColorMatrix和CISourceAtopCompositing来设置混合，最后把它们连接在一起。	</div><div class="line">// 这个方法使用了一个叫做-createPaddedGhostImageWithSize:的帮助函数，它使用Core Graphics创建了输入图像25%大小缩小版的填充的幽灵。</div><div class="line"></div><div class="line">- (UIImage *)createPaddedGhostImageWithSize:(CGSize)inputSize &#123;</div><div class="line">  UIImage * ghostImage = [UIImage imageNamed:@&quot;ghost.png&quot;];</div><div class="line">  CGFloat ghostImageAspectRatio = ghostImage.size.width / ghostImage.size.height;</div><div class="line">  </div><div class="line">  NSInteger targetGhostWidth = inputSize.width * 0.25;</div><div class="line">  CGSize ghostSize = CGSizeMake(targetGhostWidth, targetGhostWidth / ghostImageAspectRatio);</div><div class="line">  CGPoint ghostOrigin = CGPointMake(inputSize.width * 0.5, inputSize.height * 0.2);</div><div class="line">  </div><div class="line">  CGRect ghostRect = &#123;ghostOrigin, ghostSize&#125;;</div><div class="line">  </div><div class="line">  UIGraphicsBeginImageContext(inputSize);</div><div class="line">  CGContextRef context = UIGraphicsGetCurrentContext();</div><div class="line"></div><div class="line">  CGRect inputRect = &#123;CGPointZero, inputSize&#125;;</div><div class="line">  CGContextClearRect(context, inputRect);</div><div class="line"></div><div class="line">  CGAffineTransform flip = CGAffineTransformMakeScale(1.0, -1.0);</div><div class="line">  CGAffineTransform flipThenShift = CGAffineTransformTranslate(flip,0,-inputSize.height);</div><div class="line">  CGContextConcatCTM(context, flipThenShift);</div><div class="line">  CGRect transformedGhostRect = CGRectApplyAffineTransform(ghostRect, flipThenShift);</div><div class="line">  CGContextDrawImage(context, transformedGhostRect, [ghostImage CGImage]);</div><div class="line">  </div><div class="line">  UIImage * paddedGhost = UIGraphicsGetImageFromCurrentImageContext();</div><div class="line">  UIGraphicsEndImageContext();</div><div class="line">  </div><div class="line">  return paddedGhost;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="GPUImage版本"><a href="#GPUImage版本" class="headerlink" title="GPUImage版本"></a>GPUImage版本</h4><ul>
<li>GPUImage隐藏了在iOS中所有需要使用OpenGL ES的复杂的代码，并用极其简单的接口以很快的速度处理图像。    </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">- (UIImage *)processUsingGPUImage:(UIImage*)input &#123;</div><div class="line">  </div><div class="line">  // 1. Create our GPUImagePictures</div><div class="line">  GPUImagePicture * inputGPUImage = [[GPUImagePicture alloc] initWithImage:input];</div><div class="line">  </div><div class="line">  UIImage * ghostImage = [self createPaddedGhostImageWithSize:input.size];</div><div class="line">  GPUImagePicture * ghostGPUImage = [[GPUImagePicture alloc] initWithImage:ghostImage];</div><div class="line"></div><div class="line">  // 2. Setup our filter chain</div><div class="line">  GPUImageAlphaBlendFilter * alphaBlendFilter = [[GPUImageAlphaBlendFilter alloc] init];</div><div class="line">  alphaBlendFilter.mix = 0.5;</div><div class="line">  </div><div class="line">  [inputGPUImage addTarget:alphaBlendFilter atTextureLocation:0];</div><div class="line">  [ghostGPUImage addTarget:alphaBlendFilter atTextureLocation:1];</div><div class="line">  </div><div class="line">  GPUImageGrayscaleFilter * grayscaleFilter = [[GPUImageGrayscaleFilter alloc] init];</div><div class="line">  </div><div class="line">  [alphaBlendFilter addTarget:grayscaleFilter];</div><div class="line">  </div><div class="line">  // 3. Process &amp; grab output image</div><div class="line">  [inputGPUImage processImage];</div><div class="line">  [ghostGPUImage processImage];</div><div class="line">  [grayscaleFilter useNextFrameForImageCapture];</div><div class="line">  </div><div class="line">  UIImage * output = [grayscaleFilter imageFromCurrentFramebuffer];</div><div class="line">  </div><div class="line">  return output;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>1.创建GPUImagePicture对象；再次使用-createPaddedGhostImageWithSize:为一个工具。这时GPUImage会把图像纹理上传到GPU内存。</li>
<li>2.创建和链接你将要使用的滤镜。这种链接与Core Image中的滤镜链接不同，它类似于管道。在你完成后，它看起来是这样的：<br><img src="https://koenig-media.raywenderlich.com/uploads/2014/03/GPUFilterChain.png" alt="原理图" title="原理图">        </li>
<li><p>3.GPUImageAlphaBlendFilter接受两个输入，在这种情况下为顶部和底部的图像，纹理的位置很重要。-addTarget:atTextureLocation: 设置纹理为正确的输入（位置）。</p>
</li>
<li><p>4.在链中的最后一个滤镜调用-useNextFrameForImageCapture然后对两个输入调用-processImage 。这可以确保滤镜知道你想要从中抓取图像然后持有它。    </p>
</li>
</ul>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文標題:</span><a href="/2017/06/06/iOS-Image-Processing-in-iOS/">Image Processing in iOS</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主頁">Craco</a></p>
        <p><span>發布時間:</span>2017-06-06, 15:26:40</p>
        <p><span>最後更新:</span>2017-06-06, 17:47:56</p>
        <p>
            <span>原始鏈接:</span><a class="post-url" href="/2017/06/06/iOS-Image-Processing-in-iOS/" title="Image Processing in iOS">http://zhulele90.cn/2017/06/06/iOS-Image-Processing-in-iOS/</a>
            <span class="copy-path" data-clipboard-text="原文: http://zhulele90.cn/2017/06/06/iOS-Image-Processing-in-iOS/　　作者: Craco" title="點擊複製文章鏈接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>許可協議:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"姓名標示-非商業性-相同方式分享 4.0 國際"</a> 轉載請保留原文鏈接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2018/06/08/图层/">
                    图层
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2017/05/24/DOM第一讲/">
                    DOM第一讲
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目錄</strong>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Image-Processing-in-iOS"><span class="toc-number">1.</span> <span class="toc-text">Image Processing in iOS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基础知识"><span class="toc-number">1.0.1.</span> <span class="toc-text">基础知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四个流行的图形图像处理方法"><span class="toc-number">1.0.2.</span> <span class="toc-text">四个流行的图形图像处理方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#位图图像原图修改"><span class="toc-number">1.0.2.1.</span> <span class="toc-text">位图图像原图修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用Core-Graphics库"><span class="toc-number">1.0.2.2.</span> <span class="toc-text">使用Core Graphics库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用Core-Image库"><span class="toc-number">1.0.2.3.</span> <span class="toc-text">使用Core Image库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GPUImage版本"><span class="toc-number">1.0.2.4.</span> <span class="toc-text">GPUImage版本</span></a></li></ol></li></ol></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隱藏目錄"  title="點擊按鈕隱藏或者顯示文章目錄">

    <script>
        yiliaConfig.toc = ["隱藏目錄", "顯示目錄", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"Image Processing in iOS　| Craco的博客　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2018/06/08/图层/" title="上一篇: 图层">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2017/05/24/DOM第一讲/" title="下一篇: DOM第一讲">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/06/08/iOS行距调整/">iOS行距调整</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/08/图层/">图层</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/06/iOS-Image-Processing-in-iOS/">Image Processing in iOS</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/24/DOM第一讲/">DOM第一讲</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/22/冒泡排序/">冒泡排序</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/16/js第二天/">js第二天</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/15/js第一天/">js第一天</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2018 Craco
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、簡單且強大的網誌框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="簡而不減 Hexo 雙欄網誌主題  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到訪數"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本頁閱讀量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回頂部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看評論"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="轉到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>